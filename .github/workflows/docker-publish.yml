name: Build and push container (disk-optimized)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # If you have access to larger hosted runners, or use self-hosted, prefer those.
    steps:
      # 1) Maximize the available disk on the runner (Marketplace actions)
      - name: Maximize build disk space
        uses: thiagokokada/free-disk-space@v2
        with:
          remove-preinstalled: 'true'     # optional: may free lots of space; use with caution
          resize-swap: 'false'            # set true only if you understand swap changes

      # 2) Checkout code early
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3) (Optional) show disk usage for debugging
      - name: Show initial disk usage
        run: |
          df -h
          sudo du -sh /usr/* 2>/dev/null | sort -hr | head -n 25

      # 4) Prune orphan docker stuff (try to reclaim any docker artifacts that might exist)
      - name: Prune Docker (runner cleanup)
        run: |
          # prune unused containers, images, builder cache, volumes
          docker container prune --force || true
          docker image prune --all --force || true
          docker volume prune --force || true
          docker builder prune --all --force || true
          docker system prune --all --force || true

      # 5) Setup Buildx (BuildKit) and QEMU for multi-platform; BuildKit reduces temporary build noise
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      # 6) Login to container registry (example: GHCR). For Docker Hub change action and secrets below.
      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # 7) Restore build cache (optional) using GitHub Actions cache backend via Buildx (cache-from)
      #    Using Buildx cache-to=type=gha lets BuildKit export cache to GHA storage (recommended).
      - name: Build and push image (with BuildKit cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/my-app:latest
            ghcr.io/${{ github.repository_owner }}/my-app:${{ github.sha }}
          # use GitHub Actions cache for buildkit cache (persist between runs)
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # enable BuildKit inline cache metadata (helpful for smaller rebuilds)
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
          # you can reduce concurrent processes if disk is tight:
          # build-args, platforms, etc. can be added here

      # 8) A final cleanup stage to remove temporary files we created in the job
      - name: Final runner cleanup
        if: always()
        run: |
          # remove apt caches and temporary files (safe)
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* || true
          # reclaim any leftover docker buildkit caches in the runner
          docker builder prune --all --force || true
          docker system prune --all --force || true
          df -h
